{"version":3,"file":"index.js","sources":["../../index.js"],"sourcesContent":["const TEXT_ELEMENT = \"TEXT_ELEMENT\";\r\n\r\nconst PLACEMENT = \"PLACEMENT\";\r\nconst DELETION = \"DELETION\";\r\nconst UPDATE = \"UPDATE\";\r\n\r\nfunction createElement(type, props = {}, ...children) {\r\n  function createTextElement(text) {\r\n    return {\r\n      type: TEXT_ELEMENT,\r\n      props: {\r\n        nodeValue: text,\r\n        children: [],\r\n      },\r\n    };\r\n  }\r\n\r\n  return {\r\n    type,\r\n    props: {\r\n      ...props,\r\n      children: children.flat().map((child) => {\r\n        return typeof child == \"object\" ? child : createTextElement(child);\r\n      }),\r\n    },\r\n  };\r\n}\r\n\r\nfunction createDom(fiber) {\r\n  const dom =\r\n    fiber.type == TEXT_ELEMENT\r\n      ? document.createTextNode(\"\")\r\n      : document.createElement(fiber.type);\r\n\r\n  updateDom(dom, {}, fiber.props);\r\n\r\n  return dom;\r\n}\r\n\r\nconst isEvent = (key) => key.startsWith(\"on\");\r\nconst isProperty = (key) => key !== \"children\" && !isEvent(key);\r\nconst isNew = (prev, next) => (key) => prev[key] !== next[key];\r\nconst isGone = (prev, next) => (key) => !(key in next);\r\nfunction updateDom(dom, prevProps, nextProps) {\r\n  Object.keys(prevProps)\r\n    .filter(isEvent)\r\n    .filter((key) => !(key in nextProps) || isNew(prevProps, nextProps)(key))\r\n    .forEach((name) => {\r\n      const eventType = name.toLowerCase().substring(2);\r\n      dom.removeEventListener(eventType, prevProps[name]);\r\n    });\r\n\r\n  Object.keys(prevProps)\r\n    .filter(isProperty)\r\n    .filter(isGone(prevProps, nextProps))\r\n    .forEach((name) => {\r\n      dom[name] = \"\";\r\n    });\r\n\r\n  Object.keys(nextProps)\r\n    .filter(isProperty)\r\n    .filter(isNew(prevProps, nextProps))\r\n    .forEach((name) => {\r\n      dom[name] = nextProps[name];\r\n    });\r\n\r\n  Object.keys(nextProps)\r\n    .filter(isEvent)\r\n    .filter(isNew(prevProps, nextProps))\r\n    .forEach((name) => {\r\n      const eventType = name.toLowerCase().substring(2);\r\n      dom.addEventListener(eventType, nextProps[name]);\r\n    });\r\n}\r\n\r\nfunction commitRoot() {\r\n  deletions.forEach(commitWork);\r\n  commitWork(wipRoot.child);\r\n  currentRoot = wipRoot;\r\n  wipRoot = null;\r\n}\r\n\r\nfunction commitWork(fiber) {\r\n  if (!fiber) {\r\n    return;\r\n  }\r\n\r\n  let domParentFiber = fiber.parent;\r\n  while (!domParentFiber.dom) {\r\n    domParentFiber = domParentFiber.parent;\r\n  }\r\n  const domParent = domParentFiber.dom;\r\n\r\n  if (fiber.effectTag === PLACEMENT && fiber.dom != null) {\r\n    domParent.appendChild(fiber.dom);\r\n  } else if (fiber.effectTag === UPDATE && fiber.dom != null) {\r\n    updateDom(fiber.dom, fiber.alternate.props, fiber.props);\r\n  } else if (fiber.effectTag === DELETION) {\r\n    commitDeletion(fiber, domParent);\r\n  }\r\n\r\n  commitWork(fiber.child);\r\n  commitWork(fiber.sibling);\r\n}\r\n\r\nfunction commitDeletion(fiber, domParent) {\r\n  if (fiber.dom) {\r\n    domParent.removeChild(fiber.dom);\r\n  } else {\r\n    commitDeletion(fiber.child, domParent);\r\n  }\r\n}\r\n\r\nfunction render(element, container) {\r\n  wipRoot = {\r\n    dom: container,\r\n    props: {\r\n      children: [element],\r\n    },\r\n    alternate: currentRoot,\r\n  };\r\n  deletions = [];\r\n  nextUnitOfWork = wipRoot;\r\n}\r\n\r\nlet nextUnitOfWork = null;\r\nlet currentRoot = null;\r\nlet wipRoot = null;\r\nlet deletions = null;\r\n\r\nfunction workLoop(deadline) {\r\n  let shouldYield = false;\r\n  while (nextUnitOfWork && !shouldYield) {\r\n    nextUnitOfWork = performUnitOfWork(nextUnitOfWork);\r\n    shouldYield = deadline.timeRemaining() < 1;\r\n  }\r\n\r\n  if (!nextUnitOfWork && wipRoot) {\r\n    commitRoot();\r\n  }\r\n\r\n  requestIdleCallback(workLoop);\r\n}\r\n\r\nrequestIdleCallback(workLoop);\r\n\r\nfunction performUnitOfWork(fiber) {\r\n  const isFunctionComponent = fiber.type instanceof Function;\r\n  if (isFunctionComponent) {\r\n    updateFunctionComponent(fiber);\r\n  } else {\r\n    updateHostComponent(fiber);\r\n  }\r\n  if (fiber.child) {\r\n    return fiber.child;\r\n  }\r\n  let nextFiber = fiber;\r\n  while (nextFiber) {\r\n    if (nextFiber.sibling) {\r\n      return nextFiber.sibling;\r\n    }\r\n    nextFiber = nextFiber.parent;\r\n  }\r\n}\r\n\r\nlet wipFiber = null;\r\nlet hookIndex = null;\r\n\r\nfunction updateFunctionComponent(fiber) {\r\n  wipFiber = fiber;\r\n  hookIndex = 0;\r\n  wipFiber.hooks = [];\r\n  const children = [fiber.type(fiber.props)];\r\n  reconcileChildren(fiber, children);\r\n}\r\n\r\nfunction useState(initial) {\r\n  const oldHook =\r\n    wipFiber.alternate &&\r\n    wipFiber.alternate.hooks &&\r\n    wipFiber.alternate.hooks[hookIndex];\r\n  const hook = {\r\n    state: oldHook ? oldHook.state : initial,\r\n    queue: [],\r\n  };\r\n\r\n  const actions = oldHook ? oldHook.queue : [];\r\n  actions.forEach((action) => {\r\n    hook.state = action(hook.state);\r\n  });\r\n\r\n  const setState = (action) => {\r\n    hook.queue.push(action);\r\n    wipRoot = {\r\n      dom: currentRoot.dom,\r\n      props: currentRoot.props,\r\n      alternate: currentRoot,\r\n    };\r\n    nextUnitOfWork = wipRoot;\r\n    deletions = [];\r\n  };\r\n\r\n  wipFiber.hooks.push(hook);\r\n  hookIndex++;\r\n  return [hook.state, setState];\r\n}\r\n\r\nfunction updateHostComponent(fiber) {\r\n  if (!fiber.dom) {\r\n    fiber.dom = createDom(fiber);\r\n  }\r\n  reconcileChildren(fiber, fiber.props.children);\r\n}\r\n\r\nfunction reconcileChildren(wipFiber, elements) {\r\n  let index = 0;\r\n  let oldFiber = wipFiber.alternate && wipFiber.alternate.child;\r\n  let prevSibling = null;\r\n\r\n  while (index < elements.length || oldFiber != null) {\r\n    const element = elements[index];\r\n    let newFiber = null;\r\n\r\n    const sameType = oldFiber && element && element.type == oldFiber.type;\r\n\r\n    if (sameType) {\r\n      newFiber = {\r\n        type: oldFiber.type,\r\n        props: element.props,\r\n        dom: oldFiber.dom,\r\n        parent: wipFiber,\r\n        alternate: oldFiber,\r\n        effectTag: UPDATE,\r\n      };\r\n    }\r\n    if (element && !sameType) {\r\n      newFiber = {\r\n        type: element.type,\r\n        props: element.props,\r\n        dom: null,\r\n        parent: wipFiber,\r\n        alternate: null,\r\n        effectTag: PLACEMENT,\r\n      };\r\n    }\r\n    if (oldFiber && !sameType) {\r\n      oldFiber.effectTag = DELETION;\r\n      deletions.push(oldFiber);\r\n    }\r\n\r\n    if (oldFiber) {\r\n      oldFiber = oldFiber.sibling;\r\n    }\r\n\r\n    if (index === 0) {\r\n      wipFiber.child = newFiber;\r\n    } else if (element) {\r\n      prevSibling.sibling = newFiber;\r\n    }\r\n\r\n    prevSibling = newFiber;\r\n    index++;\r\n  }\r\n}\r\n\r\nconst Archway = {\r\n  createElement,\r\n  render,\r\n};\r\n\r\nexport default Archway;\r\nexport { useState };\r\n"],"names":["isEvent","key","startsWith","isProperty","isNew","prev","next","updateDom","dom","prevProps","nextProps","Object","keys","filter","forEach","name","eventType","toLowerCase","substring","removeEventListener","addEventListener","commitWork","fiber","domParentFiber","parent","domParent","effectTag","appendChild","alternate","props","commitDeletion","child","sibling","removeChild","nextUnitOfWork","currentRoot","wipRoot","deletions","performUnitOfWork","type","Function","updateFunctionComponent","wipFiber","hookIndex","hooks","children","reconcileChildren","updateHostComponent","createDom","document","createTextNode","createElement","nextFiber","requestIdleCallback","workLoop","deadline","shouldYield","timeRemaining","commitRoot","elements","index","oldFiber","prevSibling","length","element","newFiber","sameType","push","Archway","flat","map","createTextElement","text","nodeValue","render","container","useState","initial","oldHook","hook","state","queue","action"],"mappings":"oEAuCA,MAAMA,QAAWC,GAAQA,EAAIC,WAAW,MAClCC,WAAcF,GAAgB,aAARA,IAAuBD,QAAQC,GACrDG,MAAQ,CAACC,EAAMC,IAAUL,GAAQI,EAAKJ,KAASK,EAAKL,GAE1D,SAASM,UAAUC,EAAKC,EAAWC,GADpB,IAAOJ,EAEpBK,OAAOC,KAAKH,GACTI,OAAOb,SACPa,QAAQZ,KAAUA,KAAOS,IAAcN,MAAMK,EAAWC,EAAjBN,CAA4BH,KACnEa,SAASC,IACR,MAAMC,EAAYD,EAAKE,cAAcC,UAAU,GAC/CV,EAAIW,oBAAoBH,EAAWP,EAAUM,OAGjDJ,OAAOC,KAAKH,GACTI,OAAOV,YACPU,QAZiBP,EAYQI,EAZET,KAAUA,KAAOK,KAa5CQ,SAASC,IACRP,EAAIO,GAAQ,MAGhBJ,OAAOC,KAAKF,GACTG,OAAOV,YACPU,OAAOT,MAAMK,EAAWC,IACxBI,SAASC,IACRP,EAAIO,GAAQL,EAAUK,MAG1BJ,OAAOC,KAAKF,GACTG,OAAOb,SACPa,OAAOT,MAAMK,EAAWC,IACxBI,SAASC,IACR,MAAMC,EAAYD,EAAKE,cAAcC,UAAU,GAC/CV,EAAIY,iBAAiBJ,EAAWN,EAAUK,OAWhD,SAASM,WAAWC,GAClB,IAAKA,EACH,OAGF,IAAIC,EAAiBD,EAAME,OAC3B,MAAQD,EAAef,KACrBe,EAAiBA,EAAeC,OAElC,MAAMC,EAAYF,EAAef,IAzFjB,cA2FZc,EAAMI,WAAwC,MAAbJ,EAAMd,IACzCiB,EAAUE,YAAYL,EAAMd,KA1FjB,WA2FFc,EAAMI,WAAqC,MAAbJ,EAAMd,IAC7CD,UAAUe,EAAMd,IAAKc,EAAMM,UAAUC,MAAOP,EAAMO,OA7FrC,aA8FJP,EAAMI,WACfI,eAAeR,EAAOG,GAGxBJ,WAAWC,EAAMS,OACjBV,WAAWC,EAAMU,SAGnB,SAASF,eAAeR,EAAOG,GACzBH,EAAMd,IACRiB,EAAUQ,YAAYX,EAAMd,KAE5BsB,eAAeR,EAAMS,MAAON,GAgBhC,IAAIS,EAAiB,KACjBC,EAAc,KACdC,EAAU,KACVC,EAAY,KAkBhB,SAASC,kBAAkBhB,GAOzB,GAN4BA,EAAMiB,gBAAgBC,SAqBpD,SAASC,wBAAwBnB,GAC/BoB,EAAWpB,EACXqB,EAAY,EACZD,EAASE,MAAQ,GACjB,MAAMC,EAAW,CAACvB,EAAMiB,KAAKjB,EAAMO,QACnCiB,kBAAkBxB,EAAOuB,GAxBvBJ,CAAwBnB,GA0D5B,SAASyB,oBAAoBzB,GACtBA,EAAMd,MACTc,EAAMd,IArLV,SAASwC,UAAU1B,GACjB,MAAMd,EA7Ba,gBA8BjBc,EAAMiB,KACFU,SAASC,eAAe,IACxBD,SAASE,cAAc7B,EAAMiB,MAInC,OAFAhC,UAAUC,EAAK,GAAIc,EAAMO,OAElBrB,EA6KOwC,CAAU1B,IAExBwB,kBAAkBxB,EAAOA,EAAMO,MAAMgB,UA5DnCE,CAAoBzB,GAElBA,EAAMS,MACR,OAAOT,EAAMS,MAEf,IAAIqB,EAAY9B,EAChB,KAAO8B,GAAW,CAChB,GAAIA,EAAUpB,QACZ,OAAOoB,EAAUpB,QAEnBoB,EAAYA,EAAU5B,QAjB1B6B,qBAdA,SAASC,SAASC,GAChB,IAAIC,GAAc,EAClB,KAAOtB,IAAmBsB,GACxBtB,EAAiBI,kBAAkBJ,GACnCsB,EAAcD,EAASE,gBAAkB,GAGtCvB,GAAkBE,GA9DzB,SAASsB,aACPrB,EAAUvB,QAAQO,YAClBA,WAAWe,EAAQL,OACnBI,EAAcC,EACdA,EAAU,KA2DRsB,GAGFL,oBAAoBC,aAwBtB,IAAIZ,EAAW,KACXC,EAAY,KAgDhB,SAASG,kBAAkBJ,EAAUiB,GACnC,IAAIC,EAAQ,EACRC,EAAWnB,EAASd,WAAac,EAASd,UAAUG,MACpD+B,EAAc,KAElB,KAAOF,EAAQD,EAASI,QAAsB,MAAZF,GAAkB,CAClD,MAAMG,EAAUL,EAASC,GACzB,IAAIK,EAAW,KAEf,MAAMC,EAAWL,GAAYG,GAAWA,EAAQzB,MAAQsB,EAAStB,KAE7D2B,IACFD,EAAW,CACT1B,KAAMsB,EAAStB,KACfV,MAAOmC,EAAQnC,MACfrB,IAAKqD,EAASrD,IACdgB,OAAQkB,EACRd,UAAWiC,EACXnC,UApOO,WAuOPsC,IAAYE,IACdD,EAAW,CACT1B,KAAMyB,EAAQzB,KACdV,MAAOmC,EAAQnC,MACfrB,IAAK,KACLgB,OAAQkB,EACRd,UAAW,KACXF,UAhPU,cAmPVmC,IAAaK,IACfL,EAASnC,UAnPE,WAoPXW,EAAU8B,KAAKN,IAGbA,IACFA,EAAWA,EAAS7B,SAGR,IAAV4B,EACFlB,EAASX,MAAQkC,EACRD,IACTF,EAAY9B,QAAUiC,GAGxBH,EAAcG,EACdL,KAIC,MAACQ,EAAU,CACdjB,cApQF,SAASA,cAAcZ,EAAMV,EAAQ,MAAOgB,GAW1C,MAAO,CACLN,KAAAA,EACAV,MAAO,IACFA,EACHgB,SAAUA,EAASwB,OAAOC,KAAKvC,GACN,iBAATA,EAAoBA,EAfxC,SAASwC,kBAAkBC,GACzB,MAAO,CACLjC,KATe,eAUfV,MAAO,CACL4C,UAAWD,EACX3B,SAAU,KAUgC0B,CAAkBxC,QAqPlE2C,OA1JF,SAASA,OAAOV,EAASW,GACvBvC,EAAU,CACR5B,IAAKmE,EACL9C,MAAO,CACLgB,SAAU,CAACmB,IAEbpC,UAAWO,GAEbE,EAAY,GACZH,EAAiBE,uCAsDnB,SAASwC,SAASC,GAChB,MAAMC,EACJpC,EAASd,WACTc,EAASd,UAAUgB,OACnBF,EAASd,UAAUgB,MAAMD,GACrBoC,EAAO,CACXC,MAAOF,EAAUA,EAAQE,MAAQH,EACjCI,MAAO,IAqBT,OAlBgBH,EAAUA,EAAQG,MAAQ,IAClCnE,SAASoE,IACfH,EAAKC,MAAQE,EAAOH,EAAKC,UAc3BtC,EAASE,MAAMuB,KAAKY,GACpBpC,IACO,CAACoC,EAAKC,MAbKE,IAChBH,EAAKE,MAAMd,KAAKe,GAChB9C,EAAU,CACR5B,IAAK2B,EAAY3B,IACjBqB,MAAOM,EAAYN,MACnBD,UAAWO,GAEbD,EAAiBE,EACjBC,EAAY"}